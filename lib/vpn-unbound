#!/bin/sh

unbound_conf=/var/lib/unbound/unbound-resolvconf.conf

NL="
"

if [ $2 = vpn-up ]; then
  newconf="# Generated by NM dispatcher script vpn-unbound$NL"

  for d in ${VPN_IP4_DOMAINS}; do
    newconf="$newconf${NL}forward-zone:$NL	name: \"$d\"$NL"

    for ns in ${VPN_IP4_NAMESERVERS}; do
      newconf="$newconf	forward-addr: ${ns%%,*}$NL"
    done
  done

	printf %s "$newconf" >"$unbound_conf"
fi

if [ $2 = vpn-down ]; then
  echo "# Generated by NM dispatcher script vpn-unbound" > "$unbound_conf"
fi

/run/current-system/sw/bin/unbound-control -c /var/lib/unbound/unbound.conf reload
